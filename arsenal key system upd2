--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = workspace.CurrentCamera
local player = Players.LocalPlayer

--// Menu State
local MenuState = {
    aimbot = false,
    esp = false,
    hitbox = false,
    killall = false,
    rapidfire = false,
    showFOV = false,
    hitboxSize = 5,
    aimbotFOV = 200,
    rapidFireDelay = 0.1,
    aimbotPart = "Head"
}

--// GUI
local ScreenGui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
ScreenGui.Name = "DevonsArsenalMenu"

-- Main Frame
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 460, 0, 650)
MainFrame.Position = UDim2.new(0.5, -230, 0.5, -325)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Parent = ScreenGui

local UICornerMain = Instance.new("UICorner")
UICornerMain.CornerRadius = UDim.new(0, 16)
UICornerMain.Parent = MainFrame

-- Shadow for MainFrame
local Shadow = Instance.new("Frame")
Shadow.Size = UDim2.new(1, 10, 1, 10)
Shadow.Position = UDim2.new(0, -5, 0, -5)
Shadow.BackgroundColor3 = Color3.fromRGB(0,0,0)
Shadow.BackgroundTransparency = 0.8
Shadow.BorderSizePixel = 0
Shadow.ZIndex = 0
Shadow.Parent = MainFrame

local UICornerShadow = Instance.new("UICorner")
UICornerShadow.CornerRadius = UICornerMain.CornerRadius
UICornerShadow.Parent = Shadow

-- Header
local Header = Instance.new("Frame")
Header.Size = UDim2.new(1, 0, 0, 60)
Header.Position = UDim2.new(0, 0, 0, 0)
Header.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
Header.BorderSizePixel = 0
Header.Parent = MainFrame

local UICornerHeader = Instance.new("UICorner")
UICornerHeader.CornerRadius = UDim.new(0, 16)
UICornerHeader.Parent = Header

-- Gradient for header
local HeaderGradient = Instance.new("UIGradient")
HeaderGradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(60,60,60)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(45,45,45))
}
HeaderGradient.Rotation = 90
HeaderGradient.Parent = Header

-- Header Text
local HeaderLabel = Instance.new("TextLabel")
HeaderLabel.Size = UDim2.new(1, -60, 1, 0)
HeaderLabel.Position = UDim2.new(0, 10, 0, 0)
HeaderLabel.BackgroundTransparency = 1
HeaderLabel.Text = "Devons Arsenal Menu (v16)"
HeaderLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
HeaderLabel.Font = Enum.Font.GothamBold
HeaderLabel.TextSize = 26
HeaderLabel.TextXAlignment = Enum.TextXAlignment.Left
HeaderLabel.Parent = Header

-- Header Image
local HeaderImage = Instance.new("ImageLabel")
HeaderImage.Size = UDim2.new(0, 40, 0, 40)
HeaderImage.Position = UDim2.new(1, -50, 0, 10)
HeaderImage.BackgroundTransparency = 1
HeaderImage.Image = "rbxassetid://101455013322456"
HeaderImage.Parent = Header

--// Simple Key System
local keyGui = Instance.new("ScreenGui", player.PlayerGui)
keyGui.Name = "KeySystem"

local keyFrame = Instance.new("Frame")
keyFrame.Size = UDim2.new(0,400,0,200)
keyFrame.Position = UDim2.new(0.5,-200,0.5,-100)
keyFrame.BackgroundColor3 = Color3.fromRGB(40,40,40)
keyFrame.Parent = keyGui

local UICornerKF = Instance.new("UICorner")
UICornerKF.CornerRadius = UDim.new(0,12)
UICornerKF.Parent = keyFrame

local keyLabel = Instance.new("TextLabel")
keyLabel.Size = UDim2.new(1,0,0,50)
keyLabel.Position = UDim2.new(0,0,0,10)
keyLabel.Text = "Enter Key to Access Menu"
keyLabel.TextColor3 = Color3.fromRGB(255,255,255)
keyLabel.Font = Enum.Font.GothamBold
keyLabel.TextSize = 24
keyLabel.BackgroundTransparency = 1
keyLabel.Parent = keyFrame

local keyBox = Instance.new("TextBox")
keyBox.Size = UDim2.new(0.8,0,0,40)
keyBox.Position = UDim2.new(0.1,0,0,80)
keyBox.PlaceholderText = "Enter Key Here"
keyBox.Text = ""
keyBox.TextColor3 = Color3.fromRGB(255,255,255)
keyBox.BackgroundColor3 = Color3.fromRGB(60,60,60)
keyBox.Font = Enum.Font.Gotham
keyBox.TextSize = 20
keyBox.ClearTextOnFocus = true
keyBox.Parent = keyFrame

local enterButton = Instance.new("TextButton")
enterButton.Size = UDim2.new(0.5,0,0,40)
enterButton.Position = UDim2.new(0.25,0,0,140)
enterButton.Text = "Enter"
enterButton.TextColor3 = Color3.fromRGB(255,255,255)
enterButton.BackgroundColor3 = Color3.fromRGB(0,150,0)
enterButton.Font = Enum.Font.GothamBold
enterButton.TextSize = 22
enterButton.Parent = keyFrame

enterButton.MouseButton1Click:Connect(function()
    if keyBox.Text == "DEVON2025" then
        keyLabel.Text = "Valid Key!"
        keyLabel.TextColor3 = Color3.fromRGB(0,255,0)
        wait(0.5)
        keyGui:Destroy()
    else
        keyLabel.Text = "Invalid Key!"
        keyLabel.TextColor3 = Color3.fromRGB(255,0,0)
    end
end)

--// Sliders
local function createSlider(name, yPos, min, max, valueRef)
    local sliderLabel = Instance.new("TextLabel")
    sliderLabel.Size = UDim2.new(0.8,0,0,20)
    sliderLabel.Position = UDim2.new(0.1,0,0,yPos)
    sliderLabel.BackgroundTransparency = 1
    sliderLabel.TextColor3 = Color3.fromRGB(255,255,255)
    sliderLabel.Font = Enum.Font.Gotham
    sliderLabel.TextSize = 16
    sliderLabel.Text = name.." "..math.floor(valueRef[1])
    sliderLabel.Parent = MainFrame

    local slider = Instance.new("Frame")
    slider.Size = UDim2.new(0.8,0,0,10)
    slider.Position = UDim2.new(0.1,0,0,yPos+20)
    slider.BackgroundColor3 = Color3.fromRGB(100,100,100)
    slider.Parent = MainFrame

    local fill = Instance.new("Frame")
    fill.Size = UDim2.new((valueRef[1]-min)/(max-min),0,1,0)
    fill.BackgroundColor3 = Color3.fromRGB(0,200,0)
    fill.Parent = slider

    local dragging = false
    slider.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
        end
    end)
    slider.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local relative = math.clamp((input.Position.X - slider.AbsolutePosition.X)/slider.AbsoluteSize.X,0,1)
            fill.Size = UDim2.new(relative,0,1,0)
            valueRef[1] = min + (max-min)*relative
            sliderLabel.Text = name.." "..math.floor(valueRef[1])
        end
    end)
end

createSlider("Aimbot FOV", 500, 50, 500, {MenuState.aimbotFOV})
createSlider("Hitbox Size", 550, 5, 20, {MenuState.hitboxSize})
createSlider("Rapid Fire Delay", 600, 0.01, 0.5, {MenuState.rapidFireDelay})

--// Buttons
local function createButton(name, yPos, stateKey)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0.8,0,0,45)
    btn.Position = UDim2.new(0.1,0,0,yPos)
    btn.BackgroundColor3 = MenuState[stateKey] and Color3.fromRGB(0,200,0) or Color3.fromRGB(150,0,0)
    btn.BorderSizePixel = 0
    btn.Text = name
    btn.TextColor3 = Color3.fromRGB(255,255,255)
    btn.Font = Enum.Font.Gotham
    btn.TextSize = 20
    btn.Parent = MainFrame

    local UICornerBtn = Instance.new("UICorner")
    UICornerBtn.CornerRadius = UDim.new(0, 8)
    UICornerBtn.Parent = btn

    btn.MouseButton1Click:Connect(function()
        MenuState[stateKey] = not MenuState[stateKey]
        btn.BackgroundColor3 = MenuState[stateKey] and Color3.fromRGB(0,200,0) or Color3.fromRGB(150,0,0)
    end)
    return btn
end

createButton("Aimbot", 80, "aimbot")
createButton("ESP", 150, "esp")
createButton("Hitbox Extender", 220, "hitbox")
createButton("Kill All", 290, "killall")
createButton("Rapid Fire", 360, "rapidfire")
createButton("Show FOV", 430, "showFOV")

-- Head/Torso toggle
local PartToggle = Instance.new("TextButton")
PartToggle.Size = UDim2.new(0,60,0,30)
PartToggle.Position = UDim2.new(0.65,0,80/650,5)
PartToggle.BackgroundColor3 = Color3.fromRGB(80,80,80)
PartToggle.BorderSizePixel = 0
PartToggle.Text = MenuState.aimbotPart
PartToggle.TextColor3 = Color3.fromRGB(255,255,255)
PartToggle.Font = Enum.Font.Gotham
PartToggle.TextSize = 14
PartToggle.Parent = MainFrame

PartToggle.MouseButton1Click:Connect(function()
    MenuState.aimbotPart = (MenuState.aimbotPart == "Head") and "Torso" or "Head"
    PartToggle.Text = MenuState.aimbotPart
end)

-- Drag Header
local dragging = false
local dragInput, mousePos, framePos
Header.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        mousePos = input.Position
        framePos = MainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)
Header.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)
RunService.RenderStepped:Connect(function()
    if dragging and dragInput then
        local delta = dragInput.Position - mousePos
        MainFrame.Position = framePos + UDim2.new(0, delta.X, 0, delta.Y)
    end
end)

-- Right Ctrl toggle
UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.KeyCode == Enum.KeyCode.RightControl then
        MainFrame.Visible = not MainFrame.Visible
    end
end)

-- FOV Circle
local fovCircle
local function updateFOVCircle()
    if MenuState.showFOV then
        if not fovCircle then
            fovCircle = Drawing.new("Circle")
            fovCircle.Color = Color3.fromRGB(0,255,0)
            fovCircle.Thickness = 2
            fovCircle.NumSides = 100
            fovCircle.Filled = false
            fovCircle.Visible = true
        end
        local mousePos = UserInputService:GetMouseLocation()
        fovCircle.Position = Vector2.new(mousePos.X, mousePos.Y)
        fovCircle.Radius = MenuState.aimbotFOV
    elseif fovCircle then
        fovCircle:Remove()
        fovCircle = nil
    end
end

-- Utility: Get closest target
local function isEnemy(plr)
    return true -- Replace with your team check logic if needed
end

local function getClosestVisibleTarget()
    local closest, shortest = nil, math.huge
    local mouse = UserInputService:GetMouseLocation()
    for _,plr in pairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character and isEnemy(plr) and plr.Character:FindFirstChild(MenuState.aimbotPart) then
            local screenPos, onScreen = Camera:WorldToViewportPoint(plr.Character[MenuState.aimbotPart].Position)
            if onScreen then
                local dist = (Vector2.new(screenPos.X,screenPos.Y)-Vector2.new(mouse.X,mouse.Y)).Magnitude
                if dist < shortest and dist < MenuState.aimbotFOV then
                    shortest = dist
                    closest = plr.Character[MenuState.aimbotPart]
                end
            end
        end
    end
    return closest
end

-- Cheats logic
local rapidFireLast = 0
RunService.RenderStepped:Connect(function()
    updateFOVCircle()

    -- Aimbot
    if MenuState.aimbot and UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton2) then
        local targetPart = getClosestVisibleTarget()
        if targetPart then
            local mousePos = UserInputService:GetMouseLocation()
            local screenPos, _ = Camera:WorldToViewportPoint(targetPart.Position)
            local delta = Vector2.new(screenPos.X, screenPos.Y) - Vector2.new(mousePos.X, mousePos.Y)
            local smooth = 0.2
            mousemoverel(delta.X*smooth, delta.Y*smooth)
        end
    end

    -- Rapid Fire
    if MenuState.rapidfire and tick()-rapidFireLast >= MenuState.rapidFireDelay then
        rapidFireLast = tick()
        local tool = player.Character and player.Character:FindFirstChildOfClass("Tool")
        if tool then tool:Activate() end
    end

    -- Kill All
    if MenuState.killall then
        for _,plr in pairs(Players:GetPlayers()) do
            if plr ~= player and plr.Character and isEnemy(plr) and plr.Character:FindFirstChild("HumanoidRootPart") then
                if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                    player.Character.HumanoidRootPart.CFrame = plr.Character.HumanoidRootPart.CFrame * CFrame.new(0,0,3)
                    local tool = player.Character:FindFirstChildOfClass("Tool")
                    if tool then tool:Activate() end
                end
            end
        end
    end

    -- Hitbox Expander
    if MenuState.hitbox then
        for _,plr in pairs(Players:GetPlayers()) do
            if plr ~= player and plr.Character and isEnemy(plr) then
                local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
                if hrp then
                    hrp.Size = Vector3.new(MenuState.hitboxSize,MenuState.hitboxSize,MenuState.hitboxSize)
                    hrp.Transparency = 0.5
                end
            end
        end
    end

    -- ESP Boxes
    for _,plr in pairs(Players:GetPlayers()) do
        if plr ~= player and plr.Character and isEnemy(plr) then
            local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
            if hrp then
                if not hrp:FindFirstChild("ESP") then
                    local bill = Instance.new("BillboardGui")
                    bill.Name = "ESP"
                    bill.Adornee = hrp
                    bill.Size = UDim2.new(0,100,0,50)
                    bill.AlwaysOnTop = true
                    bill.Parent = hrp

                    local text = Instance.new("TextLabel")
                    text.Size = UDim2.new(1,0,1,0)
                    text.BackgroundTransparency = 1
                    text.Font = Enum.Font.GothamBold
                    text.TextScaled = true
                    text.Parent = bill
                end

                local espText = hrp.ESP:FindFirstChildOfClass("TextLabel")
                if espText and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                    local dist = (player.Character.HumanoidRootPart.Position - hrp.Position).Magnitude
                    local color = Color3.fromHSV(math.clamp(dist/1000,0,1)/3,1,1)
                    espText.TextColor3 = color
                    espText.Text = plr.Name.." ["..math.floor(dist).."m]"
                end
            end
        elseif plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
            if hrp:FindFirstChild("ESP") then
                hrp.ESP:Destroy()
            end
        end
    end
end)
